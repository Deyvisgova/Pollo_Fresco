<section class="tarjeta">
  <header class="tarjeta__encabezado">
    <h3>Registro de entregas</h3>
    <p>Registra entregas de pollos con fecha fija, proveedor guardado y cálculo automático.</p>
  </header>

  <form class="formulario" (ngSubmit)="guardarRegistro()">
    <label class="campo">
      <span>Fecha de entrega</span>
      <input [(ngModel)]="fechaEntrega" name="fechaEntrega" type="date" disabled />
    </label>
    <label class="campo">
      <span>Usuario</span>
      <input [(ngModel)]="usuarioNombre" name="usuarioNombre" type="text" disabled />
    </label>
    <label class="campo campo--completo">
      <span>Buscar proveedor guardado</span>
      <input
        [(ngModel)]="busquedaProveedor"
        name="busquedaProveedor"
        type="text"
        (input)="buscarProveedor()"
        placeholder="Escribe nombre, DNI o RUC"
      />
      <div class="sugerencias" *ngIf="proveedores.length > 0">
        <button
          class="sugerencia"
          type="button"
          *ngFor="let proveedor of proveedores"
          (click)="seleccionarProveedor(proveedor)"
        >
          {{ proveedor.nombres }} {{ proveedor.apellidos }} ({{ proveedor.ruc || proveedor.dni }})
        </button>
      </div>
    </label>

    <div class="campo campo--completo" *ngIf="proveedorSeleccionado">
      <span>Proveedor seleccionado</span>
      <strong>{{ proveedorSeleccionado.nombres }} {{ proveedorSeleccionado.apellidos }}</strong>
    </div>

    <div class="lineas">
      <div class="linea" *ngFor="let linea of lineas; let i = index">
        <label class="campo">
          <span>Cantidad de pollos</span>
          <input [(ngModel)]="linea.cantidadPollos" name="cantidadPollos{{ i }}" type="number" min="0" />
        </label>
        <label class="campo">
          <span>Peso total (kg)</span>
          <input [(ngModel)]="linea.pesoTotalKg" name="pesoTotalKg{{ i }}" type="number" min="0" step="0.01" />
        </label>
        <label class="campo">
          <span>Merma (factor)</span>
          <input [(ngModel)]="linea.mermaKg" name="mermaKg{{ i }}" type="number" min="0" step="0.01" />
        </label>
        <label class="campo">
          <span>Precio por kg (S/)</span>
          <input [(ngModel)]="linea.precioKg" name="precioKg{{ i }}" type="number" min="0" step="0.01" />
        </label>
        <button class="boton boton--link boton--peligro" type="button" (click)="eliminarLinea(i)" *ngIf="lineas.length > 1">
          Quitar
        </button>
      </div>
    </div>

    <button class="boton boton--secundario" type="button" (click)="agregarLinea()">Agregar línea</button>

    <div class="resumen">
      <p><strong>Total pollos:</strong> {{ obtenerTotales().cantidadPollos }}</p>
      <p><strong>Peso total:</strong> {{ obtenerTotales().pesoTotalKg | number: '1.2-2' }} kg</p>
      <p><strong>Merma:</strong> {{ obtenerTotales().mermaKg | number: '1.2-2' }}</p>
      <p><strong>Costo total:</strong> S/ {{ obtenerTotales().costoTotal | number: '1.2-2' }}</p>
    </div>

    <label class="campo campo--completo">
      <span>Observación</span>
      <textarea [(ngModel)]="observacion" name="observacion" rows="3"></textarea>
    </label>

    <p class="mensaje mensaje--error" *ngIf="error">{{ error }}</p>

    <div class="acciones">
      <button class="boton boton--primario" type="submit" [disabled]="guardando">
        Guardar registro
      </button>
      <button class="boton boton--secundario" type="button" (click)="limpiarFormulario()">Limpiar</button>
    </div>
  </form>
</section>

<section class="tarjeta">
  <header class="tarjeta__encabezado">
    <h3>Historial de entregas</h3>
    <p>Consulta los registros recientes y administra cada entrega.</p>
  </header>

  <div class="tabla-contenedor">
    <table class="tabla">
      <thead>
        <tr>
          <th>Proveedor</th>
          <th>Fecha</th>
          <th>Pollos</th>
          <th>Peso total</th>
          <th>Merma</th>
          <th>Costo</th>
          <th>Observación</th>
          <th>Creado en</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let registro of registros">
          <td>
            {{ registro.proveedor?.nombres }} {{ registro.proveedor?.apellidos }}
            <div class="nota">{{ registro.proveedor?.ruc || registro.proveedor?.dni }}</div>
          </td>
          <td>{{ registro.fecha_entrega }}</td>
          <td>{{ registro.cantidad_pollos }}</td>
          <td>{{ registro.peso_total_kg | number: '1.2-2' }} kg</td>
          <td>{{ registro.merma_kg | number: '1.2-2' }}</td>
          <td>S/ {{ registro.costo_total | number: '1.2-2' }}</td>
          <td>{{ registro.observacion || '-' }}</td>
          <td>{{ registro.creado_en | date: 'short' }}</td>
        </tr>
        <tr *ngIf="registros.length === 0">
          <td colspan="8">No hay registros de entrega aún.</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
